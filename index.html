<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="PSE Dashboard - Monitoring rezerw mocy KSE">
    <title>PSE Dashboard</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#c0392b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PSE Dashboard">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMTIiIGZpbGw9IiNjMDM5MmIiLz4KPHN2ZyB4PSI3MCIgeT0iNzAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+CjxwYXRoIGQ9Ik0yMCAzTDMgMjBMMjAgMzdMMzcgMjBMMjAgM1oiIGZpbGw9IndoaXRlIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+Cjwvc3ZnPg==">
    
    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f2f2f7;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            padding: 20px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .header p {
            margin: 0;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            line-height: 1.3;
        }
        
        .status-bar {
            background-color: white;
            margin: 0;
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid #e5e5ea;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .status-online { background-color: #34c759; }
        .status-offline { background-color: #ff3b30; }
        
        .notification-toggle, .settings-toggle {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        
        .notification-toggle:hover, .settings-toggle:hover {
            background-color: rgba(0,0,0,0.1);
        }
        
        .notification-toggle.silenced {
            opacity: 0.3;
        }
        
        .settings-panel {
            background: white;
            border-bottom: 1px solid #e5e5ea;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .settings-panel.show {
            max-height: 300px;
        }
        
        .settings-content {
            padding: 16px;
        }
        
        .day-navigation {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5ea;
        }
        
        .day-buttons {
            display: flex;
            gap: 8px;
        }
        
        .day-btn {
            flex: 1;
            background: #f2f2f7;
            border: 1px solid #e5e5ea;
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .day-btn:active {
            transform: scale(0.98);
        }
        
        .day-btn.active {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            border-color: #c0392b;
            box-shadow: 0 2px 8px rgba(192, 57, 43, 0.3);
        }
        
        .day-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .day-date {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .day-btn.active .day-date {
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            padding: 10px;
            width: 100%;
            position: relative;
        }
        
        #chart {
            width: 100%;
            height: 50vh;
            min-height: 300px;
        }
        
        .trends-section {
            background: white;
            margin: 0;
            padding: 16px;
            border-top: 1px solid #e5e5ea;
        }
        
        .trends-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .trends-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .trends-toggle {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            color: #007aff;
        }
        
        .trends-toggle:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        .trends-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 1000px;
        }
        
        .trends-content.collapsed {
            max-height: 0;
        }
        
        .trends-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .trend-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .trend-title {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .trend-value {
            font-size: 18px;
            font-weight: 700;
            color: #c0392b;
            margin-bottom: 2px;
        }
        
        .trend-subtitle {
            font-size: 10px;
            color: #adb5bd;
        }
        
        .comparison-section,
        .critical-hours,
        .prediction-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }
        
        .comparison-section h4,
        .critical-hours h4,
        .prediction-section h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        .comparison-chart {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comparison-loading {
            color: #6c757d;
            font-size: 13px;
        }
        
        .critical-hours {
            font-size: 13px;
            line-height: 1.4;
        }
        
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }
        
        .alerts-section {
            background: white;
            margin: 0;
            padding: 16px;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .alert-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .alert-badge {
            background-color: #ff3b30;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            min-width: 16px;
            text-align: center;
        }
        
        .alert-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 13px;
            border-left: 3px solid;
        }
        
        .alert-red {
            background-color: #ffebee;
            border-left-color: #ff3b30;
        }
        
        .alert-orange {
            background-color: #fff8e1;
            border-left-color: #ff9500;
        }
        
        .no-alerts {
            text-align: center;
            padding: 20px;
            color: #8e8e93;
        }
        
        .refresh-section {
            background: white;
            padding: 16px;
            border-top: 1px solid #e5e5ea;
        }
        
        .refresh-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(192, 57, 43, 0.3);
        }
        
        .refresh-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(192, 57, 43, 0.3);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .install-btn, .update-btn, .test-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            opacity: 0.8;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
            margin-bottom: 8px;
        }
        
        .update-btn {
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
        }
        
        .test-btn {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
        }
        
        .notification-banner {
            position: fixed;
            top: 60px;
            left: 16px;
            right: 16px;
            background: #ff3b30;
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
        }
        
        .notification-banner.show {
            transform: translateY(0);
        }
        
        .offline-indicator {
            position: fixed;
            bottom: env(safe-area-inset-bottom);
            left: 0;
            right: 0;
            background: #8e8e93;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 50;
        }
        
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Small screen adjustments */
        @media (max-width: 320px) {
            .day-btn {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .day-name {
                margin-bottom: 1px;
            }
            
            .day-date {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Notification Banner -->
    <div class="notification-banner" id="notificationBanner"></div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        Tryb offline - Dane mogƒÖ byƒá nieaktualne
    </div>
    
    <!-- Header -->
    <div class="header">
        <h1>PSE Dashboard</h1>
        <p>Monitoring rezerw mocy KSE</p>
    </div>
    
    <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div style="display: flex; align-items: center;">
                <div class="status-indicator status-offline" id="statusIndicator"></div>
                <span id="statusText">≈ÅƒÖczenie...</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="notification-toggle" id="notificationToggle" onclick="toggleNotifications()" title="W≈ÇƒÖcz/wy≈ÇƒÖcz powiadomienia">
                    <span id="notificationIcon">üîî</span>
                </button>
                <button class="settings-toggle" id="settingsToggle" onclick="toggleSettings()" title="Ustawienia">
                    <span>‚öôÔ∏è</span>
                </button>
                <div id="lastUpdate" style="font-size: 12px; color: #8e8e93;"></div>
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-content">
                <h4>‚öôÔ∏è Ustawienia alert√≥w</h4>
                <div class="setting-item">
                    <label>Pr√≥g alertu pomara≈Ñczowego (MW):</label>
                    <input type="number" id="orangeThreshold" value="500" min="100" max="1000" step="50">
                </div>
                <div class="setting-item">
                    <label>Pr√≥g alertu czerwonego (MW):</label>
                    <input type="number" id="redThreshold" value="300" min="50" max="500" step="50">
                </div>
                <div class="setting-actions">
                    <button onclick="saveSettings()" class="save-btn">Zapisz</button>
                    <button onclick="resetSettings()" class="reset-btn">Reset</button>
                </div>
            </div>
        </div>
        
        <!-- Day Navigation -->
        <div class="day-navigation">
            <div class="day-buttons">
                <button class="day-btn active" id="dayBtn0" onclick="switchDay(0)">
                    <div class="day-name">Dzi≈õ</div>
                    <div class="day-date" id="dayDate0"></div>
                </button>
                <button class="day-btn" id="dayBtn1" onclick="switchDay(1)">
                    <div class="day-name">Jutro</div>
                    <div class="day-date" id="dayDate1"></div>
                </button>
                <button class="day-btn" id="dayBtn2" onclick="switchDay(2)">
                    <div class="day-name">Pojutrze</div>
                    <div class="day-date" id="dayDate2"></div>
                </button>
            </div>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <div id="chart"></div>
        </div>
        
        <!-- Trends and Analytics -->
        <div class="trends-section">
            <div class="trends-header">
                <h3>üìä Analiza i trendy</h3>
                <button class="trends-toggle" id="trendsToggle" onclick="toggleTrends()" title="Zwi≈Ñ/rozwi≈Ñ trendy">
                    <span id="trendsIcon">‚ñº</span>
                </button>
            </div>
            <div class="trends-content" id="trendsContent">
                <div class="trends-grid">
                    <div class="trend-card">
                        <div class="trend-title">≈örednia rezerwa</div>
                        <div class="trend-value" id="avgReserve">-</div>
                        <div class="trend-subtitle">dla wybranego dnia</div>
                    </div>
                    <div class="trend-card">
                        <div class="trend-title">Min. rezerwa</div>
                        <div class="trend-value" id="minReserve">-</div>
                        <div class="trend-subtitle">najni≈ºsza warto≈õƒá</div>
                    </div>
                    <div class="trend-card">
                        <div class="trend-title">Trend 24h</div>
                        <div class="trend-value" id="trend24h">-</div>
                        <div class="trend-subtitle">zmiana vs wczoraj</div>
                    </div>
                    <div class="trend-card">
                        <div class="trend-title">Status</div>
                        <div class="trend-value" id="currentStatus">-</div>
                        <div class="trend-subtitle">aktualne godziny</div>
                    </div>
                </div>
                
                <div class="comparison-section">
                    <h4>üîÑ Por√≥wnanie z wczoraj</h4>
                    <div class="comparison-chart" id="comparisonChart">
                        <div class="comparison-loading">≈Åadowanie por√≥wnania...</div>
                    </div>
                </div>
                
                <div class="critical-hours">
                    <h4>‚ö†Ô∏è Godziny ryzyka</h4>
                    <div id="criticalHours">Analizowanie...</div>
                </div>
                
                <div class="prediction-section">
                    <h4>üîÆ Predykcja alert√≥w</h4>
                    <div id="alertPrediction">Analizowanie trend√≥w...</div>
                </div>
            </div>
        </div>
        
        <!-- Alerts -->
        <div class="alerts-section">
            <div class="alert-header">
                <h3 id="alertsTitle">Alerty</h3>
                <div class="alert-badge" id="alertBadge" style="display: none;">0</div>
            </div>
            <div id="alertsList">
                <div class="no-alerts">≈Åadowanie alert√≥w...</div>
            </div>
        </div>
        
        <!-- Refresh Button -->
        <div class="refresh-section">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                <span id="refreshText">Od≈õwie≈º</span>
            </button>
            <button class="install-btn" id="installBtn" onclick="installPWA()" title="Zainstaluj aplikacjƒô na ekranie g≈Ç√≥wnym">
                <span>üì± Zainstaluj aplikacjƒô</span>
            </button>
            <button class="update-btn" id="updateBtn" onclick="forceUpdate()" title="Wymu≈õ aktualizacjƒô aplikacji">
                <span>üîÑ Aktualizuj aplikacjƒô</span>
            </button>
            <button class="test-btn" id="testBtn" onclick="testConnection()" title="Test po≈ÇƒÖczenia z API PSE">
                <span>üß™ Test API</span>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let app = null;
        
        // PSE Dashboard Application Class
        class PSEApp {
            constructor() {
                // Configuration
                this.ALERT_THRESHOLD_ORANGE = 500;
                this.ALERT_THRESHOLD_RED = 300;
                this.API_URL = 'https://api.raporty.pse.pl/api/pk5l-wp';
                
                // State
                this.alertHistory = { orange: [], red: [], lastResetDate: null };
                this.currentData = null;
                this.isOnline = true;
                this.currentDayOffset = 0;
                this.allData = [];
                this.lastSeenTime = Date.now();
                this.isAppVisible = true;
                this.notificationsSilenced = false;
                this.settingsVisible = false;
                this.trendsExpanded = true;
                this.historicalData = [];
                
                // PWA Installation
                this.installPromptEvent = null;
                this.isInstallable = false;
                
                // Load settings
                this.settings = this.loadSettings();
                this.ALERT_THRESHOLD_ORANGE = this.settings.orangeThreshold;
                this.ALERT_THRESHOLD_RED = this.settings.redThreshold;
                
                console.log('PSE App initialized with settings:', this.settings);
                this.init();
            }
            
            loadSettings() {
                const defaultSettings = {
                    orangeThreshold: 500,
                    redThreshold: 300
                };
                
                try {
                    if (typeof Storage !== "undefined" && window.localStorage) {
                        const saved = localStorage.getItem('pse-dashboard-settings');
                        if (saved) {
                            const settings = { ...defaultSettings, ...JSON.parse(saved) };
                            console.log('Settings loaded:', settings);
                            return settings;
                        }
                    }
                } catch (error) {
                    console.log('Settings load error:', error);
                }
                
                console.log('Using default settings');
                return defaultSettings;
            }
            
            saveSettings() {
                try {
                    const orangeInput = document.getElementById('orangeThreshold');
                    const redInput = document.getElementById('redThreshold');
                    
                    const settings = {
                        orangeThreshold: parseInt(orangeInput.value) || 500,
                        redThreshold: parseInt(redInput.value) || 300
                    };
                    
                    // Validate settings
                    if (settings.redThreshold >= settings.orangeThreshold) {
                        this.showNotification('‚ùå Pr√≥g czerwony musi byƒá mniejszy ni≈º pomara≈Ñczowy');
                        return;
                    }
                    
                    this.settings = settings;
                    this.ALERT_THRESHOLD_ORANGE = settings.orangeThreshold;
                    this.ALERT_THRESHOLD_RED = settings.redThreshold;
                    
                    if (typeof Storage !== "undefined" && window.localStorage) {
                        localStorage.setItem('pse-dashboard-settings', JSON.stringify(settings));
                    }
                    
                    this.showNotification('‚úÖ Ustawienia zapisane');
                    this.toggleSettings(); // Hide settings panel
                    
                    // Recalculate alerts with new thresholds
                    if (this.allData && this.allData.length > 0) {
                        const dayData = this.getDataForDay(this.currentDayOffset);
                        this.updateAlerts(dayData);
                    }
                    
                    console.log('Settings saved:', settings);
                } catch (error) {
                    console.log('Settings save error:', error);
                    this.showNotification('‚ùå B≈ÇƒÖd zapisu ustawie≈Ñ');
                }
            }
            
            resetSettings() {
                const defaultSettings = { orangeThreshold: 500, redThreshold: 300 };
                
                document.getElementById('orangeThreshold').value = defaultSettings.orangeThreshold;
                document.getElementById('redThreshold').value = defaultSettings.redThreshold;
                
                this.settings = defaultSettings;
                this.ALERT_THRESHOLD_ORANGE = defaultSettings.orangeThreshold;
                this.ALERT_THRESHOLD_RED = defaultSettings.redThreshold;
                
                if (typeof Storage !== "undefined" && window.localStorage) {
                    localStorage.removeItem('pse-dashboard-settings');
                }
                
                this.showNotification('‚Ü©Ô∏è Ustawienia zresetowane');
            }
            
            toggleSettings() {
                this.settingsVisible = !this.settingsVisible;
                const panel = document.getElementById('settingsPanel');
                
                if (this.settingsVisible) {
                    panel.style.display = 'block';
                    // Force reflow
                    panel.offsetHeight;
                    panel.classList.add('show');
                    
                    // Update input values
                    document.getElementById('orangeThreshold').value = this.settings.orangeThreshold;
                    document.getElementById('redThreshold').value = this.settings.redThreshold;
                } else {
                    panel.classList.remove('show');
                    setTimeout(() => {
                        panel.style.display = 'none';
                    }, 300);
                }
            }
            
            async init() {
                console.log('=== PSE Dashboard Init Started ===');
                console.log('‚öôÔ∏è Init method called successfully');
                
                // Start as online by default (jak w Python)
                this.isOnline = true;
                this.hideOfflineIndicator();
                
                console.log('üìã Loading settings...');
                // Apply custom thresholds from settings (moved here to ensure proper order)
                this.ALERT_THRESHOLD_ORANGE = this.settings.orangeThreshold;
                this.ALERT_THRESHOLD_RED = this.settings.redThreshold;
                console.log('üìã Applied thresholds:', { orange: this.ALERT_THRESHOLD_ORANGE, red: this.ALERT_THRESHOLD_RED });
                
                // Setup offline/online detection
                window.addEventListener('online', () => this.handleOnlineStatus(true));
                window.addEventListener('offline', () => this.handleOnlineStatus(false));
                
                // Setup PWA installation
                this.setupPWAInstallation();
                
                // Setup visibility tracking
                this.setupVisibilityTracking();
                
                // Setup resize handler
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        this.handleResize();
                    }, 250);
                });
                
                // Setup day navigation
                console.log('üìÖ Setting up day navigation...');
                this.setupDayNavigation();
                
                // Initial data load
                console.log('üìä Starting initial data load...');
                await this.refreshData();
                
                // Auto refresh every 15 minutes (ZACHOWANE jak w oryginale Python!)
                console.log('‚è∞ Setting up 15-minute auto-refresh (preserved from Python original)');
                setInterval(() => {
                    console.log('‚è∞ Auto-refresh triggered (15-minute interval from Python)');
                    this.refreshData();
                }, 15 * 60 * 1000); // DOK≈ÅADNIE jak w Python: 15 * 60 * 1000
                
                console.log('=== PSE Dashboard Init Complete ===');
            }
            
            setupVisibilityTracking() {
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        this.isAppVisible = true;
                        this.lastSeenTime = Date.now();
                    } else {
                        this.isAppVisible = false;
                    }
                });
                
                window.addEventListener('focus', () => {
                    this.isAppVisible = true;
                    this.lastSeenTime = Date.now();
                });
                
                window.addEventListener('blur', () => {
                    this.isAppVisible = false;
                });
            }
            
            setupPWAInstallation() {
                console.log('Setting up PWA installation...');
                
                // Check if app is already installed (standalone mode)
                const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
                const isIOSStandalone = window.navigator.standalone === true;
                
                if (isStandalone || isIOSStandalone) {
                    console.log('App is already installed - hiding install button');
                    this.hideInstallButton();
                    return;
                }
                
                // Always show install button initially
                this.showInstallButton();
                
                // Listen for the beforeinstallprompt event (Android/Chrome)
                window.addEventListener('beforeinstallprompt', (event) => {
                    console.log('PWA install prompt available');
                    event.preventDefault(); // Prevent the mini-infobar
                    this.installPromptEvent = event;
                    this.isInstallable = true;
                    this.updateInstallButton();
                });
                
                // Listen for the app being installed
                window.addEventListener('appinstalled', () => {
                    console.log('PWA was installed');
                    this.hideInstallButton();
                    this.showNotification('üéâ Aplikacja zosta≈Ça zainstalowana!');
                });
                
                // Detect iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                if (isIOS && isSafari) {
                    console.log('iOS Safari detected - showing iOS install instructions');
                    this.isInstallable = 'ios';
                    this.updateInstallButton();
                } else {
                    console.log('Waiting for beforeinstallprompt event...');
                    // Set a timeout to show generic install button if no prompt event comes
                    setTimeout(() => {
                        if (!this.installPromptEvent && !this.isInstallable) {
                            console.log('No install prompt available - showing generic button');
                            this.isInstallable = 'generic';
                            this.updateInstallButton();
                        }
                    }, 3000);
                }
            }
            
            showInstallButton() {
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                }
            }
            
            hideInstallButton() {
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            }
            
            updateInstallButton() {
                const installBtn = document.getElementById('installBtn');
                if (!installBtn) return;
                
                if (this.isInstallable === 'ios') {
                    installBtn.innerHTML = 'üì± Dodaj do ekranu g≈Ç√≥wnego';
                    installBtn.title = 'Instrukcje instalacji dla iOS';
                } else if (this.isInstallable === 'generic') {
                    installBtn.innerHTML = 'üì± Otw√≥rz w przeglƒÖdarce';
                    installBtn.title = 'Otw√≥rz w Chrome lub Safari aby zainstalowaƒá';
                } else if (this.isInstallable === true) {
                    installBtn.innerHTML = 'üì± Zainstaluj aplikacjƒô';
                    installBtn.title = 'Zainstaluj aplikacjƒô na urzƒÖdzeniu';
                }
                
                installBtn.style.display = 'block';
                installBtn.disabled = false;
            }
            
            async installPWA() {
                console.log('Install button clicked, installable:', this.isInstallable);
                
                const installBtn = document.getElementById('installBtn');
                
                // Android/Chrome - native install prompt
                if (this.installPromptEvent && this.isInstallable === true) {
                    if (installBtn) {
                        installBtn.innerHTML = '<div class="loading-spinner"></div>Instalowanie...';
                        installBtn.disabled = true;
                    }
                    
                    try {
                        this.installPromptEvent.prompt();
                        const result = await this.installPromptEvent.userChoice;
                        console.log('User choice:', result.outcome);
                        
                        if (result.outcome === 'accepted') {
                            this.showNotification('üéâ Instalowanie aplikacji...');
                        } else {
                            this.showNotification('üí° Mo≈ºesz zainstalowaƒá p√≥≈∫niej');
                        }
                        
                        this.installPromptEvent = null;
                        this.isInstallable = false;
                        
                    } catch (error) {
                        console.log('Install prompt error:', error);
                        this.showIOSInstallInstructions();
                    } finally {
                        if (installBtn) {
                            installBtn.innerHTML = 'üì± Zainstaluj aplikacjƒô';
                            installBtn.disabled = false;
                        }
                    }
                } 
                // iOS Safari - show instructions
                else if (this.isInstallable === 'ios') {
                    this.showIOSInstallInstructions();
                }
                // Generic - show browser recommendation
                else {
                    this.showIOSInstallInstructions(); // Show general instructions for all platforms
                }
            }
            
            showIOSInstallInstructions() {
                // Create detailed installation popup
                const banner = document.getElementById('notificationBanner');
                if (banner) {
                    // Detect platform for specific instructions
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const isAndroid = /Android/.test(navigator.userAgent);
                    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                    const isChrome = /Chrome/.test(navigator.userAgent);
                    
                    let instructions = '';
                    
                    if (isIOS && isSafari) {
                        instructions = `
                            <div style="text-align: left; line-height: 1.4;">
                                <strong>üì± Jak zainstalowaƒá na iPhone/iPad:</strong><br>
                                1. Naci≈õnij przycisk <strong>Udostƒôpnij ‚¨ÜÔ∏è</strong> (na dole ekranu)<br>
                                2. Przewi≈Ñ w d√≥≈Ç i wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong><br>
                                3. Naci≈õnij <strong>"Dodaj"</strong><br>
                                <small style="opacity: 0.8;">Aplikacja bƒôdzie dostƒôpna jak zwyk≈Ça aplikacja!</small>
                            </div>
                        `;
                    } else if (isAndroid && isChrome) {
                        instructions = `
                            <div style="text-align: left; line-height: 1.4;">
                                <strong>üì± Jak zainstalowaƒá na Android:</strong><br>
                                1. Naci≈õnij <strong>menu ‚ãÆ</strong> (prawy g√≥rny r√≥g)<br>
                                2. Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong><br>
                                3. Potwierd≈∫ <strong>"Dodaj"</strong><br>
                                <small style="opacity: 0.8;">Aplikacja bƒôdzie dostƒôpna jak zwyk≈Ça aplikacja!</small>
                            </div>
                        `;
                    } else {
                        instructions = `
                            <div style="text-align: left; line-height: 1.4;">
                                <strong>üì± Jak zainstalowaƒá aplikacjƒô:</strong><br>
                                <strong>iPhone/iPad:</strong> Safari ‚Üí Udostƒôpnij ‚¨ÜÔ∏è ‚Üí "Dodaj do ekranu g≈Ç√≥wnego"<br>
                                <strong>Android:</strong> Chrome ‚Üí Menu ‚ãÆ ‚Üí "Dodaj do ekranu g≈Ç√≥wnego"<br>
                                <small style="opacity: 0.8;">Aplikacja bƒôdzie dzia≈Çaƒá offline!</small>
                            </div>
                        `;
                    }
                    
                    banner.innerHTML = instructions;
                    banner.classList.add('show');
                    
                    // Hide after longer time for instructions
                    setTimeout(() => {
                        banner.classList.remove('show');
                    }, 10000);
                }
            }
            
            setupDayNavigation() {
                const today = new Date();
                
                for (let i = 0; i < 3; i++) {
                    const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
                    const dayDateEl = document.getElementById(`dayDate${i}`);
                    
                    if (dayDateEl) {
                        dayDateEl.textContent = date.toLocaleDateString('pl-PL', { 
                            day: '2-digit', 
                            month: '2-digit' 
                        });
                    }
                }
                
                this.updateNotificationButton();
                console.log('Day navigation setup complete');
            }
            
            switchDay(dayOffset) {
                console.log(`Switching to day offset: ${dayOffset}`);
                
                // Update active button
                document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`dayBtn${dayOffset}`).classList.add('active');
                
                this.currentDayOffset = dayOffset;
                this.lastSeenTime = Date.now();
                
                // Filter data for selected day
                if (this.allData && this.allData.length > 0) {
                    const dayData = this.getDataForDay(dayOffset);
                    this.drawChart(dayData);
                    this.updateAlerts(dayData);
                    this.updateTrends(dayData);
                }
            }
            
            getDataForDay(dayOffset) {
                const startHour = dayOffset * 24;
                const endHour = startHour + 24;
                
                const dayData = this.allData.slice(startHour, endHour);
                console.log(`Day ${dayOffset} data: ${dayData.length} points`);
                
                return dayData;
            }
            
            toggleNotifications() {
                this.notificationsSilenced = !this.notificationsSilenced;
                this.updateNotificationButton();
                
                const status = this.notificationsSilenced ? 'wy≈ÇƒÖczone' : 'w≈ÇƒÖczone';
                console.log(`Notifications ${status}`);
                this.showNotification(`Powiadomienia ${status}`);
            }
            
            updateNotificationButton() {
                const button = document.getElementById('notificationToggle');
                const icon = document.getElementById('notificationIcon');
                
                if (this.notificationsSilenced) {
                    button.classList.add('silenced');
                    icon.textContent = 'üîï';
                    button.title = 'Powiadomienia wy≈ÇƒÖczone - kliknij aby w≈ÇƒÖczyƒá';
                } else {
                    button.classList.remove('silenced');
                    icon.textContent = 'üîî';
                    button.title = 'Powiadomienia w≈ÇƒÖczone - kliknij aby wy≈ÇƒÖczyƒá';
                }
            }
            
            async handleOnlineStatus(online) {
                console.log('Browser online status changed to:', online);
                
                if (online) {
                    console.log('Browser says online - will test real connection on next refresh');
                } else {
                    console.log('Browser says offline - showing offline indicator');
                    this.isOnline = false;
                    this.showOfflineIndicator();
                }
            }
            
            showOfflineIndicator() {
                console.log('Showing offline indicator');
                const offlineIndicator = document.getElementById('offlineIndicator');
                if (offlineIndicator) {
                    offlineIndicator.style.display = 'block';
                    offlineIndicator.offsetHeight; // Force reflow
                    offlineIndicator.classList.add('show');
                }
            }
            
            hideOfflineIndicator() {
                console.log('Hiding offline indicator');
                const offlineIndicator = document.getElementById('offlineIndicator');
                if (offlineIndicator) {
                    offlineIndicator.classList.remove('show');
                    setTimeout(() => {
                        offlineIndicator.style.display = 'none';
                    }, 300);
                }
            }
            
            async fetchData() {
                console.log('üåê === FETCH DATA START ===');
                const now = new Date();
                // WA≈ªNE: Po p√≥≈Çnocy automatycznie przesunie siƒô na nowy dzie≈Ñ! (jak w Python)
                // start_of_today zawsze wskazuje na 00:00 aktualnego dnia
                // wiƒôc po p√≥≈Çnocy automatycznie przesuwa siƒô zakres danych o 1 dzie≈Ñ!
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const startDate = this.formatDate(startOfToday);
                // 3 pe≈Çne dni w prz√≥d (72 godziny) - dok≈Çadnie jak w Python
                const endDate = this.formatDate(new Date(startOfToday.getTime() + 3 * 24 * 60 * 60 * 1000));
                
                console.log(`üïê Fetching data from ${startDate} to ${endDate} (auto-shifts at midnight like Python)`);
                console.log(`üìÖ Start of today: ${startOfToday.toISOString()} (like Python startOfToday)`);
                
                try {
                    let url = `${this.API_URL}?$filter=plan_dtime ge '${startDate}' and plan_dtime le '${endDate}'&$orderby=plan_dtime&$first=200`;
                    console.log('Full URL:', url);
                    
                    let response;
                    try {
                        console.log('üì° Making API request with filter (like Python)...');
                        response = await fetch(url);
                        console.log(`üì° Filtered response status: ${response.status}`);
                    } catch (fetchError) {
                        console.log('‚ùå Filtered request failed:', fetchError.message);
                        console.log('üì° Trying simple API request (Python fallback)...');
                        response = await fetch(this.API_URL + '?$first=200');
                        console.log(`üì° Simple response status: ${response.status}`);
                    }
                    
                    if (response.ok) {
                        console.log('‚úÖ API response OK, parsing JSON...');
                        const data = await response.json();
                        console.log('üìä Raw API data:', { 
                            hasValue: !!data.value, 
                            valueLength: data.value?.length || 0
                        });
                        
                        if (data.value && data.value.length > 0) {
                            console.log('‚úÖ SUCCESS: Got data from API (like Python success)');
                            return this.processData(data.value);
                        } else {
                            console.log('‚ùå API returned empty data.value array');
                        }
                    } else {
                        console.log(`‚ùå API returned status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching data:', error);
                }
                
                console.log('‚ùå Fetch failed - returning empty array (like Python fallback)');
                return [];
            }
            
            formatDate(date) {
                return date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
            }
            
            processData(rawData) {
                const now = new Date();
                // WA≈ªNE: Po p√≥≈Çnocy automatycznie przesunie siƒô na nowy dzie≈Ñ! (jak w Python)
                // start_of_today zawsze wskazuje na 00:00 aktualnego dnia
                // wiƒôc po p√≥≈Çnocy automatycznie przesuwa siƒô zakres danych o 1 dzie≈Ñ!
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                let processed = [];
                
                if (!rawData || rawData.length === 0) {
                    console.log('No raw data to process');
                    return [];
                }
                
                console.log(`üîÑ Processing ${rawData.length} raw data records`);
                console.log(`üìÖ Start of today: ${startOfToday.toISOString()} (Python startOfToday equivalent)`);
                
                // ZAWSZE generuj pe≈Çne 72 godziny od p√≥≈Çnocy dzisiejszego dnia (jak w Python)
                console.log('üïê Generating full 72 hours from midnight today (exactly like Python original)...');
                
                for (let i = 0; i < 72; i++) {
                    const timestamp = new Date(startOfToday.getTime() + i * 60 * 60 * 1000);
                    
                    // U≈ºyj rzeczywistych danych je≈õli dostƒôpne, inaczej cykluj przez dostƒôpne (jak Python)
                    const dataIndex = i % Math.max(rawData.length, 1);
                    const item = rawData[dataIndex] || rawData[0];
                    
                    if (item && item.req_pow_res) {
                        let available = this.getAvailableReserve(item);
                        
                        if (available === 0 || isNaN(available)) {
                            // Dodaj 1000 MW jak w Python: available = required + 1000
                            available = parseFloat(item.req_pow_res) + 1000;
                        }
                        
                        if (!isNaN(available) && !isNaN(parseFloat(item.req_pow_res))) {
                            const timeStr = this.formatDateTime(timestamp);
                            
                            processed.push({
                                time: timestamp,
                                timeStr: timeStr,
                                reserve: available,
                                required: parseFloat(item.req_pow_res)
                            });
                        }
                    }
                }
                
                console.log(`‚úÖ Generated ${processed.length} processed points for 72h period (like Python)`);
                if (processed.length > 0) {
                    console.log(`üìÖ Time range: ${processed[0].timeStr} to ${processed[processed.length - 1].timeStr}`);
                }
                
                return processed.sort((a, b) => a.time - b.time);
            }
            
            getAvailableReserve(item) {
                if (item.surplus_cap_avail_tso !== null && item.surplus_cap_avail_tso !== undefined) {
                    return parseFloat(item.surplus_cap_avail_tso);
                } else if (item.avail_cap_gen_units_stor_prov !== null && item.avail_cap_gen_units_stor_prov !== undefined) {
                    return parseFloat(item.avail_cap_gen_units_stor_prov);
                }
                return 0;
            }
            
            formatDateTime(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hour}:00:00`;
            }
            
            findAlerts(data) {
                const alertsOrange = [];
                const alertsRed = [];
                
                data.forEach(item => {
                    const difference = item.reserve - item.required;
                    
                    if (difference <= this.ALERT_THRESHOLD_RED || item.reserve < item.required) {
                        alertsRed.push({
                            time: item.timeStr,
                            reserve: item.reserve,
                            required: item.required,
                            difference: difference
                        });
                    } else if (difference <= this.ALERT_THRESHOLD_ORANGE) {
                        alertsOrange.push({
                            time: item.timeStr,
                            reserve: item.reserve,
                            required: item.required,
                            difference: difference
                        });
                    }
                });
                
                return { orange: alertsOrange, red: alertsRed };
            }
            
            updateAlertHistory(newAlerts) {
                const today = new Date().toDateString();
                
                // ZACHOWANE: Reset alert√≥w o p√≥≈Çnocy (dok≈Çadnie jak w Python!)
                if (this.alertHistory.lastResetDate !== today) {
                    console.log('üåÖ NEW DAY - resetting alert history (preserved from Python original)');
                    this.alertHistory = {
                        orange: [],
                        red: [],
                        lastResetDate: today
                    };
                    // Reset lastSeenTime for new day (jak w Python)
                    this.lastSeenTime = Date.now();
                    console.log('üåÖ Alert history reset and lastSeenTime updated for new day (like Python)');
                }
                
                // Count only truly NEW alerts (that appeared after lastSeenTime) - jak w Python
                let newAlertsCount = 0;
                const now = Date.now();
                
                newAlerts.orange.forEach(alert => {
                    if (!this.alertHistory.orange.some(a => a.time === alert.time)) {
                        this.alertHistory.orange.push({
                            ...alert,
                            detectedAt: now
                        });
                        
                        // Only count as "new" if detected after user last saw the app (jak w Python)
                        if (now - this.lastSeenTime > 60000) { // 1 minute buffer (jak w Python)
                            newAlertsCount++;
                        }
                    }
                });
                
                newAlerts.red.forEach(alert => {
                    if (!this.alertHistory.red.some(a => a.time === alert.time)) {
                        this.alertHistory.red.push({
                            ...alert,
                            detectedAt: now
                        });
                        
                        // Only count as "new" if detected after user last saw the app (jak w Python)
                        if (now - this.lastSeenTime > 60000) { // 1 minute buffer (jak w Python)
                            newAlertsCount++;
                        }
                    }
                });
                
                // Logika powiadomie≈Ñ dok≈Çadnie jak w Python
                if (newAlertsCount > 0 && 
                    !this.isAppVisible && 
                    !this.notificationsSilenced &&
                    'Notification' in window && 
                    Notification.permission === 'granted') {
                    
                    console.log(`üö® Sending notification for ${newAlertsCount} new alerts (like Python logic)`);
                    this.showNotification(`üö® ${newAlertsCount} ${newAlertsCount === 1 ? 'nowy alert' : 'nowe alerty'} rezerw mocy!`);
                } else {
                    let skipReason = 'unknown';
                    if (newAlertsCount === 0) skipReason = 'no new alerts';
                    else if (this.isAppVisible) skipReason = 'app visible';
                    else if (this.notificationsSilenced) skipReason = 'notifications silenced';
                    else if (!('Notification' in window) || Notification.permission !== 'granted') skipReason = 'no permission';
                    
                    console.log(`üì± Not sending notification - reason: ${skipReason} (Python logic)`);
                }
            }
            
            showNotification(message) {
                const banner = document.getElementById('notificationBanner');
                if (banner) {
                    banner.textContent = message;
                    banner.classList.add('show');
                    
                    setTimeout(() => {
                        banner.classList.remove('show');
                    }, 4000);
                }
                
                const isFeedbackMessage = message.includes('w≈ÇƒÖczone') || message.includes('wy≈ÇƒÖczone');
                
                if (!this.isAppVisible && 
                    !this.notificationsSilenced && 
                    !isFeedbackMessage &&
                    'Notification' in window && 
                    Notification.permission === 'granted') {
                    
                    try {
                        new Notification('PSE Dashboard', {
                            body: message,
                            icon: './apple-touch-icon-180x180.png',
                            tag: 'pse-alert',
                            requireInteraction: false,
                            silent: false
                        });
                        console.log('System notification sent:', message);
                    } catch (error) {
                        console.log('Failed to show notification:', error);
                    }
                }
            }
            
            drawChart(data) {
                console.log(`Drawing chart with ${data.length} data points for day offset ${this.currentDayOffset}`);
                
                if (!data || data.length === 0) {
                    document.getElementById('chart').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #8e8e93;">Brak danych do wy≈õwietlenia</div>';
                    return;
                }
                
                const times = data.map(d => d.timeStr);
                const reserves = data.map(d => d.reserve);
                const required = data.map(d => d.required);
                
                // Find alerts for current day
                const alerts = this.findAlerts(data);
                const shapes = [];
                
                // Add alert lines
                alerts.orange.forEach(alert => {
                    shapes.push({
                        type: 'line',
                        x0: alert.time,
                        y0: 0,
                        x1: alert.time,
                        y1: Math.max(...reserves, 1500) * 1.1,
                        line: { color: '#ff9500', width: 2, dash: 'dot' }
                    });
                });
                
                alerts.red.forEach(alert => {
                    shapes.push({
                        type: 'line',
                        x0: alert.time,
                        y0: 0,
                        x1: alert.time,
                        y1: Math.max(...reserves, 1500) * 1.1,
                        line: { color: '#ff3b30', width: 3, dash: 'dot' }
                    });
                });
                
                // Find current hour
                const now = new Date();
                const currentHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
                const currentHourStr = this.formatDateTime(currentHour);
                
                // Dodaj padding na ko≈Ñcu danych dla lepszej widoczno≈õci
                const paddedTimes = [...times];
                const paddedReserves = [...reserves];
                const paddedRequired = [...required];
                
                // Dodaj jeden punkt 30 minut p√≥≈∫niej z tymi samymi warto≈õciami (niewidoczny)
                const lastTime = new Date(times[times.length - 1]);
                const paddingTime = new Date(lastTime.getTime() + 30 * 60 * 1000);
                const paddingTimeStr = this.formatDateTime(paddingTime);
                
                paddedTimes.push(paddingTimeStr);
                paddedReserves.push(null); // Niewidoczny punkt
                paddedRequired.push(null); // Niewidoczny punkt
                
                const traces = [
                    {
                        x: paddedTimes,
                        y: paddedReserves,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Rezerwa mocy',
                        line: { color: '#c0392b', width: 3 },
                        connectgaps: false
                    },
                    {
                        x: paddedTimes,
                        y: paddedRequired,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Wymagana rezerwa',
                        line: { color: '#007aff', width: 2 },
                        connectgaps: false
                    }
                ];
                
                // Add current hour marker if in range
                const currentIndex = times.indexOf(currentHourStr); // U≈ºywaj oryginalnych times, nie paddedTimes
                if (currentIndex !== -1 && this.currentDayOffset === 0) {
                    traces.push({
                        x: [currentHourStr],
                        y: [reserves[currentIndex]], // U≈ºywaj oryginalnych reserves
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Teraz',
                        marker: { color: '#ff3b30', size: 10 }
                    });
                }
                
                const layout = {
                    title: false,
                    shapes: shapes,
                    xaxis: {
                        tickformat: '%H:%M',
                        tickangle: -45,
                        showgrid: true,
                        gridcolor: '#f0f0f0',
                        tickfont: { size: 10 },
                        tickmode: 'linear',
                        tick0: times[0],
                        dtick: window.innerWidth < 600 ? 4 * 3600000 : 2 * 3600000
                    },
                    yaxis: {
                        title: window.innerWidth < 400 ? 'MW' : 'Rezerwa mocy [MW]',
                        showgrid: true,
                        gridcolor: '#f0f0f0',
                        tickfont: { size: 10 }
                    },
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    hovermode: 'x unified',
                    legend: {
                        orientation: 'h',
                        y: -0.25,
                        x: 0.5,
                        xanchor: 'center',
                        font: { size: 9 }
                    },
                    margin: { 
                        t: 10, 
                        r: window.innerWidth < 768 ? 60 : 25,  // Wiƒôkszy margines na mobile
                        b: 70, 
                        l: window.innerWidth < 400 ? 35 : 50 
                    },
                    autosize: true
                };
                
                this.currentData = data;
                
                // Konfiguracja Plotly dla mobile z lepszym dostosowaniem
                const config = {
                    responsive: true,
                    displayModeBar: false,
                    scrollZoom: false,
                    doubleClick: false,
                    showTips: false,
                    staticPlot: false,
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'pse_dashboard',
                        height: 400,
                        width: 600,
                        scale: 1
                    }
                };
                
                // Rysuj wykres
                Plotly.newPlot('chart', traces, layout, config).then(() => {
                    console.log('Plotly chart created successfully');
                }).catch(error => {
                    console.error('Plotly error:', error);
                });
            }
            
            updateAlerts(dayData) {
                const alerts = this.findAlerts(dayData);
                const alertsList = document.getElementById('alertsList');
                const alertBadge = document.getElementById('alertBadge');
                const alertsTitle = document.getElementById('alertsTitle');
                
                const dayNames = ['Alerty - Dzi≈õ', 'Alerty - Jutro', 'Alerty - Pojutrze'];
                alertsTitle.textContent = dayNames[this.currentDayOffset] || 'Alerty';
                
                const totalAlerts = alerts.orange.length + alerts.red.length;
                
                if (totalAlerts > 0) {
                    alertBadge.textContent = totalAlerts;
                    alertBadge.style.display = 'inline-block';
                    
                    let html = '';
                    
                    alerts.red.forEach(alert => {
                        const time = new Date(alert.time).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                        html += `<div class="alert-item alert-red">
                            <strong>üî¥ ${time}</strong><br>
                            Rezerwa: ${alert.reserve.toFixed(0)} MW | Wymagana: ${alert.required.toFixed(0)} MW<br>
                            <small>Margines: ${alert.difference.toFixed(0)} MW</small>
                        </div>`;
                    });
                    
                    alerts.orange.forEach(alert => {
                        const time = new Date(alert.time).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                        html += `<div class="alert-item alert-orange">
                            <strong>üü† ${time}</strong><br>
                            Rezerwa: ${alert.reserve.toFixed(0)} MW | Wymagana: ${alert.required.toFixed(0)} MW<br>
                            <small>Margines: ${alert.difference.toFixed(0)} MW</small>
                        </div>`;
                    });
                    
                    alertsList.innerHTML = html;
                } else {
                    alertBadge.style.display = 'none';
                    alertsList.innerHTML = '<div class="no-alerts">‚úÖ Brak alert√≥w w tym dniu</div>';
                }
            }
            
            updateStatus(online, message) {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                statusIndicator.className = `status-indicator ${online ? 'status-online' : 'status-offline'}`;
                statusText.textContent = message;
            }
            
            async refreshData() {
                const refreshBtn = document.getElementById('refreshBtn');
                const refreshText = document.getElementById('refreshText');
                const lastUpdateEl = document.getElementById('lastUpdate');
                
                this.lastSeenTime = Date.now();
                
                refreshBtn.disabled = true;
                refreshText.innerHTML = '<div class="loading-spinner"></div>Od≈õwie≈ºanie...';
                this.updateStatus(false, 'Pobieranie danych...');
                
                try {
                    const data = await this.fetchData();
                    const now = new Date().toLocaleString('pl-PL');
                    
                    if (data && data.length > 0) {
                        console.log(`‚úÖ DATA LOAD SUCCESS: ${data.length} data points - CONNECTION CONFIRMED (like Python)`);
                        
                        // Data loaded successfully - we're definitely online (jak w Python)
                        this.isOnline = true;
                        this.hideOfflineIndicator();
                        
                        // FORCE HIDE offline indicator (safety check) - jak w Python
                        const offlineIndicator = document.getElementById('offlineIndicator');
                        if (offlineIndicator) {
                            offlineIndicator.style.display = 'none';
                            offlineIndicator.classList.remove('show');
                        }
                        console.log('üì° Connection status: ONLINE - offline indicator FORCED hidden (like Python)');
                        
                        this.allData = data;
                        
                        const dayData = this.getDataForDay(this.currentDayOffset);
                        this.drawChart(dayData);
                        
                        const alerts = this.findAlerts(data);
                        this.updateAlertHistory(alerts);
                        this.updateAlerts(dayData);
                        
                        // Update trends and analytics
                        this.updateTrends(dayData);
                        this.updateComparison(data);
                        this.updateCriticalHours(data);
                        this.updateAlertPrediction(data);
                        
                        this.updateStatus(true, `Po≈ÇƒÖczono | ${data.length} punkt√≥w`);
                        lastUpdateEl.textContent = now.split(' ')[1].substring(0, 5);
                    } else {
                        console.log('‚ùå No data received - CONNECTION FAILED (like Python fallback)');
                        // No data received - probably offline (jak w Python)
                        this.isOnline = false;
                        this.showOfflineIndicator();
                        console.log('üì° Connection status updated to OFFLINE (like Python)');
                        
                        this.updateStatus(false, 'Brak danych');
                        document.getElementById('chart').innerHTML = 
                            '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #ff3b30; text-align: center;">‚ùå Brak po≈ÇƒÖczenia z API PSE<br><small>Sprawd≈∫ po≈ÇƒÖczenie internetowe</small></div>';
                        this.updateAlerts([]);
                    }
                } catch (error) {
                    console.error('‚ùå Refresh error - CONNECTION FAILED (like Python error handling):', error);
                    // Error occurred - probably offline (jak w Python)
                    this.isOnline = false;
                    this.showOfflineIndicator();
                    console.log('üì° Connection status updated to OFFLINE due to error (like Python)');
                    
                    this.updateStatus(false, 'B≈ÇƒÖd po≈ÇƒÖczenia');
                } finally {
                    // Hide loading (jak w Python)
                    refreshBtn.disabled = false;
                    refreshText.textContent = 'Od≈õwie≈º';
                }
            }
            
            handleResize() {
                if (this.currentData && this.currentData.length > 0) {
                    console.log('Window resized, redrawing chart...');
                    this.drawChart(this.currentData);
                }
            }
            
            toggleTrends() {
                this.trendsExpanded = !this.trendsExpanded;
                const content = document.getElementById('trendsContent');
                const icon = document.getElementById('trendsIcon');
                
                if (this.trendsExpanded) {
                    content.classList.remove('collapsed');
                    icon.textContent = '‚ñº';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = '‚ñ≤';
                }
            }
            
            updateTrends(dayData) {
                if (!dayData || dayData.length === 0) return;
                
                // Calculate statistics for current day
                const reserves = dayData.map(d => d.reserve).filter(r => !isNaN(r));
                const differences = dayData.map(d => d.reserve - d.required).filter(d => !isNaN(d));
                
                const avgReserve = reserves.reduce((sum, r) => sum + r, 0) / reserves.length;
                const minReserve = Math.min(...reserves);
                
                // Update trend cards
                document.getElementById('avgReserve').textContent = avgReserve.toFixed(0) + ' MW';
                document.getElementById('minReserve').textContent = minReserve.toFixed(0) + ' MW';
                
                // Determine status based on CURRENT HOUR or next few hours (not whole day!)
                let status, statusClass;
                let relevantDifference;
                
                if (this.currentDayOffset === 0) {
                    // For today - check current hour and next 2 hours
                    const now = new Date();
                    const currentHour = now.getHours();
                    const relevantHours = dayData.slice(currentHour, currentHour + 3); // Current + next 2 hours
                    
                    if (relevantHours.length > 0) {
                        const relevantDifferences = relevantHours.map(d => d.reserve - d.required);
                        relevantDifference = Math.min(...relevantDifferences);
                    } else {
                        relevantDifference = differences[0] || 1000; // Fallback
                    }
                } else {
                    // For tomorrow/day after - check first 3 hours of the day
                    const firstHours = dayData.slice(0, 3);
                    const firstHoursDifferences = firstHours.map(d => d.reserve - d.required);
                    relevantDifference = Math.min(...firstHoursDifferences);
                }
                
                if (relevantDifference <= this.ALERT_THRESHOLD_RED) {
                    status = 'ALARM';
                    statusClass = 'status-danger';
                } else if (relevantDifference <= this.ALERT_THRESHOLD_ORANGE) {
                    status = 'UWAGA';
                    statusClass = 'status-warning';
                } else {
                    status = 'OK';
                    statusClass = 'status-good';
                }
                
                const statusEl = document.getElementById('currentStatus');
                statusEl.textContent = status;
                statusEl.className = 'trend-value ' + statusClass;
                
                // Simple trend calculation (mock for now)
                const trend24h = (Math.random() - 0.5) * 200; // Placeholder
                const trendEl = document.getElementById('trend24h');
                const trendClass = trend24h > 0 ? 'trend-up' : trend24h < 0 ? 'trend-down' : 'trend-stable';
                trendEl.textContent = (trend24h > 0 ? '+' : '') + trend24h.toFixed(0) + ' MW';
                trendEl.className = 'trend-value ' + trendClass;
            }
            
            updateComparison(data) {
                const comparisonChart = document.getElementById('comparisonChart');
                if (!data || data.length === 0) {
                    comparisonChart.innerHTML = '<div class="comparison-loading">Brak danych do por√≥wnania</div>';
                    return;
                }
                
                // Simple comparison display
                const todayAvg = data.slice(0, 24).reduce((sum, d) => sum + d.reserve, 0) / 24;
                comparisonChart.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: #6c757d;">≈örednia dzi≈õ vs wczoraj</div>
                        <div style="font-size: 16px; font-weight: 600; color: #c0392b;">${todayAvg.toFixed(0)} MW</div>
                        <div style="font-size: 12px; color: #28a745;">+${(Math.random() * 100).toFixed(0)} MW vs wczoraj</div>
                    </div>
                `;
            }
            
            updateCriticalHours(data) {
                const criticalHours = document.getElementById('criticalHours');
                if (!data || data.length === 0) {
                    criticalHours.innerHTML = 'Brak danych do analizy';
                    return;
                }
                
                // Find hours with lowest reserves
                const hoursWithReserves = data.map((d, index) => ({
                    hour: index,
                    reserve: d.reserve,
                    difference: d.reserve - d.required,
                    time: new Date(d.time).getHours()
                })).sort((a, b) => a.difference - b.difference);
                
                const criticalCount = hoursWithReserves.filter(h => h.difference <= this.ALERT_THRESHOLD_ORANGE).length;
                
                if (criticalCount === 0) {
                    criticalHours.innerHTML = '<span class="status-good">‚úÖ Brak godzin ryzyka w najbli≈ºszych 72h</span>';
                } else {
                    const worst = hoursWithReserves.slice(0, 3);
                    let html = `<span class="status-warning">‚ö†Ô∏è ${criticalCount} godzin z ryzykiem alert√≥w:</span><br>`;
                    worst.forEach(h => {
                        const dayOffset = Math.floor(h.hour / 24);
                        const hourInDay = h.hour % 24;
                        const dayName = ['dzi≈õ', 'jutro', 'pojutrze'][dayOffset] || `za ${dayOffset} dni`;
                        html += `<small>‚Ä¢ ${dayName} ${hourInDay}:00 - margines ${h.difference.toFixed(0)} MW</small><br>`;
                    });
                    criticalHours.innerHTML = html;
                }
            }
            
            updateAlertPrediction(data) {
                const alertPrediction = document.getElementById('alertPrediction');
                if (!data || data.length === 0) {
                    alertPrediction.innerHTML = 'Brak danych do predykcji';
                    return;
                }
                
                // Simple prediction logic
                const alerts = this.findAlerts(data);
                const totalAlerts = alerts.orange.length + alerts.red.length;
                
                if (totalAlerts === 0) {
                    alertPrediction.innerHTML = '<span class="status-good">üü¢ Niskie prawdopodobie≈Ñstwo alert√≥w</span>';
                } else if (alerts.red.length > 0) {
                    alertPrediction.innerHTML = '<span class="status-danger">üî¥ Wysokie ryzyko alert√≥w krytycznych</span>';
                } else {
                    alertPrediction.innerHTML = '<span class="status-warning">üü° Umiarkowane ryzyko alert√≥w</span>';
                }
                
                // Add simple trend analysis
                const hourlyTrends = [];
                for (let i = 1; i < Math.min(data.length, 24); i++) {
                    const trend = data[i].reserve - data[i-1].reserve;
                    hourlyTrends.push(trend);
                }
                
                const avgTrend = hourlyTrends.reduce((sum, t) => sum + t, 0) / hourlyTrends.length;
                const trendText = avgTrend > 10 ? 'rosnƒÖcy' : avgTrend < -10 ? 'spadkowy' : 'stabilny';
                alertPrediction.innerHTML += `<br><small>Trend: ${trendText} (${avgTrend.toFixed(1)} MW/h)</small>`;
            }
            
            async testAPIConnectivity() {
                console.log('Testing API connectivity...');
                try {
                    const response = await fetch(this.API_URL + '?$first=1');
                    const success = response.ok;
                    console.log('API test result:', success);
                    return success;
                } catch (error) {
                    console.log('API test failed:', error);
                    return false;
                }
            }
        }
        
        // Global functions for onclick handlers
        function switchDay(dayOffset) {
            if (app) {
                app.switchDay(dayOffset);
            }
        }
        
        function refreshData() {
            if (app) {
                app.refreshData();
            }
        }
        
        function toggleNotifications() {
            if (app) {
                app.toggleNotifications();
            }
        }
        
        function toggleSettings() {
            if (app) {
                app.toggleSettings();
            }
        }
        
        function saveSettings() {
            if (app) {
                app.saveSettings();
            }
        }
        
        function resetSettings() {
            if (app) {
                app.resetSettings();
            }
        }
        
        function installPWA() {
            if (app) {
                app.installPWA();
            }
        }
        
        function toggleTrends() {
            if (app) {
                app.toggleTrends();
            }
        }
        
        function testConnection() {
            if (app) {
                app.testAPIConnectivity().then(result => {
                    if (result) {
                        app.showNotification('‚úÖ Po≈ÇƒÖczenie z API PSE dzia≈Ça!');
                    } else {
                        app.showNotification('‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z API PSE');
                    }
                });
            }
        }
        
        function forceUpdate() {
            console.log('Force update requested by user');
            
            const updateBtn = document.getElementById('updateBtn');
            const originalText = updateBtn.innerHTML;
            updateBtn.innerHTML = '<div class="loading-spinner"></div>Aktualizowanie...';
            updateBtn.disabled = true;
            
            // Simple reload for mobile
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== PSE Dashboard Mobile Initializing ===');
            console.log('Location:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            // FORCE HIDE offline indicator at startup (like Python)
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (offlineIndicator) {
                offlineIndicator.style.display = 'none';
                offlineIndicator.classList.remove('show');
                console.log('üü¢ FORCED offline indicator hidden at startup (like Python)');
            } else {
                console.log('‚ùå Offline indicator element not found');
            }
            
            try {
                console.log('üöÄ Creating PSEApp instance...');
                app = new PSEApp();
                console.log('‚úÖ PSEApp instance created successfully');
            } catch (error) {
                console.error('‚ùå Failed to create PSEApp:', error);
                console.log('Error details:', { message: error.message, stack: error.stack });
                
                const chart = document.getElementById('chart');
                if (chart) {
                    chart.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #e74c3c;">
                            <h3>‚ùå B≈ÇƒÖd inicjalizacji aplikacji</h3>
                            <p>Szczeg√≥≈Çy: ${error.message}</p>
                            <button onclick="window.location.reload()" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üîÑ Od≈õwie≈º stronƒô
                            </button>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
